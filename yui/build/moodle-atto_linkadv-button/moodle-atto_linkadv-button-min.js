YUI.add("moodle-atto_linkadv-button",function(e,t){var n="atto_linkadv",r={LINK:"LINK",ADVANCED:"ADVANCED"},i={URL_INPUT:"atto_linkadv_url_entry",NEWWINDOW:"atto_linkadv_openinnewwindow",ID_INPUT:"atto_linkadv_id_entry",CLASS_INPUT:"atto_linkadv_class_entry",LINK:r.LINK.toLowerCase(),ADVANCED:r.ADVANCED.toLowerCase(),FILEPICKER:"atto_linkadv_filepicker"},s={URL_INPUT:"."+i.URL_INPUT,NEWWINDOW:"."+i.NEWWINDOW,ID_INPUT:"."+i.ID_INPUT,CLASS_INPUT:"."+i.CLASS_INPUT,FILEPICKER:"."+i.FILEPICKER},o='<form class="mform atto_form atto_linkadv" id="{{elementid}}_atto_linkadv_form"><ul class="root nav nav-tabs" role="tablist"><li data-type="{{CSS.LINK}}" class="nav-item"><a class="nav-link active" href="#{{elementid}}_{{CSS.LINK}}" role="tab" data-toggle="tab">{{get_string "link" component}}</a></li><li data-type="{{CSS.ADVANCED}}" class="nav-item"><a class="nav-link" href="#{{elementid}}_{{CSS.ADVANCED}}" role="tab" data-toggle="tab">{{get_string "advanced" component}}</a></li></ul><div class="root tab-content"><div data-type="{{CSS.LINK}}" class="tab-pane active" id="{{elementid}}_{{CSS.LINK}}"><label for="{{elementid}}_atto_linkadv_url_entry">{{get_string "enterurl" component}}</label><input class="fullwidth {{CSS.URL_INPUT}}" type="url" id="{{elementid}}_atto_linkadv_url_entry" size="32"/><br/>{{#if showFilepicker}}<button class="{{CSS.FILEPICKER}}">{{get_string "browserepositories" component}}</button><br/>{{/if}}<input type="checkbox" class="{{CSS.NEWWINDOW}}" id="{{elementid}}_{{CSS.NEWWINDOW}}"/><label class="sameline" for="{{elementid}}_{{CSS.NEWWINDOW}}">{{get_string "openinnewwindow" component}}</label></div><div data-type="{{CSS.ADVANCED}}" class="tab-pane" id="{{elementid}}_{{CSS.ADVANCED}}"><label for="{{elementid}}_{{CSS.ID_INPUT}}">{{get_string "enterid" component}}</label><input class="fullwidth {{CSS.ID_INPUT}}" type="text" id="{{elementid}}_{{CSS.ID_INPUT}}" size="32" /><label for="{{elementid}}_{{CSS.CLASS_INPUT}}">{{get_string "enterclass" component}}</label><input class="fullwidth {{CSS.CLASS_INPUT}}" type="text" id="{{elementid}}_{{CSS.CLASS_INPUT}}" size="32" /></div></div><div class="mdl-align"><br/><button class="submit" type="submit">{{get_string "createlink" component}}</button></div></form>';e.namespace("M.atto_linkadv").Button=e.Base.create("button",e.M.editor_atto.EditorPlugin,[],{_currentSelection:null,_content:null,initializer:function(){this.addButton({icon:"e/insert_edit_link",keys:"75",callback:this._displayDialogue,tags:"a",tagMatchRequiresAll:!1}),this.addButton({buttonName:"unlink",callback:this._unlink,icon:"e/remove_link",title:"unlink",tags:"a",tagMatchRequiresAll:!1})},_displayDialogue:function(){this._currentSelection=this.get("host").getSelection();if(this._currentSelection===!1)return;var e=this.getDialogue({headerContent:M.util.get_string("createlink",n),focusAfterHide:!0,width:660,focusOnShowSelector:s.URL_INPUT});e.set("bodyContent",this._getDialogueContent()),this._resolveAnchors(),e.show()},_resolveAnchors:function(){var t=this.get("host").getSelectionParentNode(),n,r,i,o,u,a;if(!t)return;n=this._findSelectedAnchors(e.one(t)),n.length>0&&(r=n[0],this._currentSelection=this.get("host").getSelectionFromNode(r),i=r.getAttribute("href"),o=r.getAttribute("target"),u=r.getAttribute("id"),a=r.getAttribute("class"),i!==""&&this._content.one(s.URL_INPUT).setAttribute("value",i),o==="_blank"?this._content.one(s.NEWWINDOW).setAttribute("checked","checked"):this._content.one(s.NEWWINDOW).removeAttribute("checked"),u!==""&&(u.startsWith("yui_")&&(u=""),this._content.one(s.ID_INPUT).setAttribute("value",u)),a!==""&&this._content.one(s.CLASS_INPUT).setAttribute("value",a))},_filepickerCallback:function(e){this.getDialogue().set("focusAfterHide",null).hide(),e.url!==""&&(this._setLinkOnSelection(e.url,"",""),this.markUpdated())},_setLink:function(e){var t,n,r,i,o,u;e.preventDefault(),this.getDialogue({focusAfterHide:null}).hide(),t=this._content.one(s.URL_INPUT),n=t.get("value"),r=this._content.one(s.ID_INPUT),i=r.get("value"),o=this._content.one(s.CLASS_INPUT),u=o.get("value"),i.startsWith("yui_")&&(i=""),i!==""&&(i=i.trim(),i=i.replace(/ /g,"-"),n===""&&(n="#"+i)),u!==""&&n===""&&(n="#");if(n!==""){n=n.trim();var a=new RegExp(/^[a-zA-Z]*\.*\/|^#|^[a-zA-Z]*:/);a.test(n)||(n="http://"+n),this._setLinkOnSelection(n,i,u),this.markUpdated()}},_setLinkOnSelection:function(t,n,r){var i=this.get("host"),o,u,a,f;this.editor.focus(),i.setSelection(this._currentSelection),this._currentSelection[0].collapsed?(o=e.Node.create("<a>"+t+"</a>"),o.setAttribute("href",t),o.setAttribute("id",n),o.setAttribute("class",r),u=i.insertContentAtFocusPoint(o.get("outerHTML")),i.setSelection(i.getSelectionFromNode(u))):(document.execCommand("unlink",!1,null),document.execCommand("createLink",!1,t),u=i.getSelectionParentNode());if(!u)return;return f=this._findSelectedAnchors(e.one(u)),e.Array.each(f,function(e){a=this._content.one(s.NEWWINDOW),a.get("checked")?e.setAttribute("target","_blank"):e.removeAttribute("target"),n!==""?e.setAttribute("id",n):e.removeAttribute("id"),r!==""?e.setAttribute("class",r):e.removeAttribute("class")},this),u},_findSelectedAnchors:function(e){var t=e.get("tagName"),n,r;return t&&t.toLowerCase()==="a"?[e]:(r=[],e.all("a").each(function(e){!n&&this.get("host").selectionContainsNode(e)&&r.push(e)},this),r.length>0?r:(n=e.ancestor("a"),n?[n]:[]))},_getDialogueContent:function(){var t=this.get("host").canShowFilepicker("link");return this._content=e.Node.create(e.Handlebars.compile(o)(this._getContext())),this._content.one(".submit").on("click",this._setLink,this),t&&this._content.one(s.FILEPICKER).on("click",function(e){e.preventDefault(),this.get("host").showFilepicker("link",this._filepickerCallback,this)},this),this._content},_getContext:function(t){var r=this.get("host").canShowFilepicker("link");return e.merge({elementid:this.get("host").get("elementid"),component:n,showFilepicker:r,CSS:i},t)},_unlink:function(){var e=this.get("host"),t=e.getSelection();if(
t&&t.length)if(t[0].startOffset===t[0].endOffset){var n=e.getSelectedNodes();n&&(n.each(function(t){var n=t.ancestor("a",!0);n&&(e.setSelection(e.getSelectionFromNode(n)),document.execCommand("unlink",!1,null))},this),this.markUpdated())}else document.execCommand("unlink",!1,null),this.markUpdated()}})},"@VERSION@",{requires:["moodle-editor_atto-plugin"]});
