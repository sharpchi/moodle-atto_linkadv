YUI.add("moodle-atto_linkadv-button",function(h,t){var n="atto_linkadv",e={LINK:"LINK",ADVANCED:"ADVANCED"},i={NEWWINDOW:"atto_linkadv_openinnewwindow",URLINPUT:"atto_linkadv_urlentry",URLTEXT:"atto_link_urltext",IDINPUT:"atto_linkadv_identry",CLASSINPUT:"atto_linkadv_classentry",LINK:e.LINK.toLowerCase(),ADVANCED:e.ADVANCED.toLowerCase(),LINKBROWSER:"openlinkbrowser"},_={NEWWINDOW:"."+i.NEWWINDOW,URLINPUT:"."+i.URLINPUT,URLTEXT:"."+i.URLTEXT,SUBMIT:".submit",LINKBROWSER:"."+i.LINKBROWSER,IDINPUT:"."+i.IDINPUT,CLASSINPUT:"."+i.CLASSINPUT};h.namespace("M.atto_linkadv").Button=h.Base.create("button",h.M.editor_atto.EditorPlugin,[],{_currentSelection:null,_content:null,_hasTextToDisplay:!1,_hasPlainTextSelected:!1,initializer:function(){this.addButton({icon:"e/insert_edit_link",keys:"75",callback:this._displayDialogue,tags:"a",tagMatchRequiresAll:!1}),this.addButton({buttonName:"unlink",callback:this._unlink,icon:"e/remove_link",title:"unlink",tags:"a",tagMatchRequiresAll:!1})},_displayDialogue:function(){var t;this._currentSelection=this.get("host").getSelection(),!1!==this._currentSelection&&((t=this.getDialogue({headerContent:M.util.get_string("createlink",n),focusAfterHide:!0,width:360,focusOnShowSelector:_.URLINPUT})).set("bodyContent",this._getDialogueContent()),this._resolveAnchors(),t.show())},_resolveAnchors:function(){var t,e,n,i,o,l=this.get("host").getSelectionParentNode();l&&(0<(l=this._findSelectedAnchors(h.one(l))).length?(l=l[0],this._currentSelection=this.get("host").getSelectionFromNode(l),t=l.getAttribute("href"),e=l.getAttribute("target"),i=l.get("innerText"),o=l.getAttribute("title"),n=l.getAttribute("id"),l=l.getAttribute("class"),""!==t&&this._content.one(_.URLINPUT).setAttribute("value",t),""!==i?this._content.one(_.URLTEXT).set("value",i):""!==o&&this._content.one(_.URLTEXT).set("value",o),"_blank"===e?this._content.one(_.NEWWINDOW).setAttribute("checked","checked"):this._content.one(_.NEWWINDOW).removeAttribute("checked"),""!==n&&(n.startsWith("yui_")&&(n=""),this._content.one(_.IDINPUT).setAttribute("value",n)),""!==l&&this._content.one(_.CLASSINPUT).setAttribute("value",l)):""!==(i=this._getTextSelection())&&(this._hasTextToDisplay=!0,this._hasPlainTextSelected=!0,this._content.one(_.URLTEXT).set("value",i)))},_filepickerCallback:function(t){this.getDialogue().set("focusAfterHide",null).hide(),""!==t.url&&(this._setLinkOnSelection(t.url,"",""),this.markUpdated())},_setLink:function(t){var e,n;t.preventDefault(),this.getDialogue({focusAfterHide:null}).hide(),t=this._content.one(_.URLINPUT).get("value"),e=this._content.one(_.IDINPUT).get("value"),n=this._content.one(_.CLASSINPUT).get("value"),""!==(e=e.startsWith("yui_")?"":e)&&(e=(e=e.trim()).replace(/ /g,"-"),""===t&&(t="#"+e)),""!==(t=""!==n&&""===t?"#":t)&&(t=t.trim(),new RegExp(/^[a-zA-Z]*\.*\/|^#|^[a-zA-Z]*:/).test(t)||(t="http://"+t),this._setLinkOnSelection(t,e,n),this.markUpdated())},_setLinkOnSelection:function(t,e,n){var i,o,l,s,u,a,r,d,c=this.get("host");if(this.editor.focus(),c.setSelection(this._currentSelection),o=!this._currentSelection[0].collapsed,l=this._content.one(_.URLTEXT),""===(s=l.get("value").replace(/(<([^>]+)>)/gi,"").trim())&&(s=t),o){if(0<h.UA.gecko){for(u=document.getSelection(),(a=document.createElement("span")).setAttribute("data-wrapper",""),a.style.display="inline",r=0;r<u.rangeCount;r++)u.getRangeAt(r).surroundContents(a);c.setSelection(c.getSelectionFromNode(h.one(a))),document.execCommand("unlink",!1,null),document.execCommand("createLink",!1,t),d=a.parentNode,a.children.forEach(function(t){d.appendChild(t)}),a.remove()}else document.execCommand("unlink",!1,null),document.execCommand("createLink",!1,t);i=c.getSelectionParentNode()}else(l=h.Node.create("<a>"+s+"</a>")).setAttribute("href",t),l.setAttribute("id",e),l.setAttribute("class",n),i=c.insertContentAtFocusPoint(l.get("outerHTML")),c.setSelection(c.getSelectionFromNode(i));if(i)return t=this._findSelectedAnchors(h.one(i)),h.Array.each(t,function(t){this._content.one(_.NEWWINDOW).get("checked")?t.setAttribute("target","_blank"):t.removeAttribute("target"),o&&s&&(this._hasPlainTextSelected?t.set("innerText",s):t.setAttribute("title",s)),""!==e?t.setAttribute("id",e):t.removeAttribute("id"),""!==n?t.setAttribute("class",n):t.removeAttribute("class")},this),i},_findSelectedAnchors:function(t){var e,n,i=t.get("tagName");return i&&"a"===i.toLowerCase()?[t]:(n=[],t.all("a").each(function(t){!e&&this.get("host").selectionContainsNode(t)&&n.push(t)},this),0<n.length?n:(e=t.ancestor("a"))?[e]:[])},_getDialogueContent:function(){var t=this.get("host").canShowFilepicker("link"),e=h.Handlebars.compile(
'<form class="atto_form"><ul class="root nav nav-tabs" role="tablist"><li data-type="{{CSS.LINK}}" class="nav-item"><a class="nav-link active" href="#{{elementid}}_{{CSS.LINK}}" role="tab" data-toggle="tab">{{get_string "link" component}}</a></li><li data-type="{{CSS.ADVANCED}}" class="nav-item"><a class="nav-link" href="#{{elementid}}_{{CSS.ADVANCED}}" role="tab" data-toggle="tab">{{get_string "advanced" component}}</a></li></ul><div class="root tab-content"><div data-type="{{CSS.LINK}}" class="tab-pane active" id="{{elementid}}_{{CSS.LINK}}"><div class="mb-1"><label for="{{elementid}}_atto_linkadv_urltext">{{get_string "texttodisplay" component}}</label><input class="form-control fullwidth {{CSS.URLTEXT}}" type="text" id="{{elementid}}_atto_linkadv_urltext" size="32"/></div>{{#if showFilepicker}}<label for="{{elementid}}_atto_linkadv_urlentry">{{get_string "enterurl" component}}</label><div class="input-group input-append w-100 mb-1"><input class="form-control url {{CSS.URLINPUT}}" type="url" id="{{elementid}}_atto_linkadv_urlentry"/><span class="input-group-append"><button class="btn btn-secondary {{CSS.LINKBROWSER}}" type="button">{{get_string "browserepositories" component}}</button></span></div>{{else}}<div class="mb-1"><label for="{{elementid}}_atto_linkadv_urlentry">{{get_string "enterurl" component}}</label><input class="form-control fullwidth url {{CSS.URLINPUT}}" type="url" id="{{elementid}}_atto_linkadv_urlentry" size="32"/></div>{{/if}}<div class="form-check"><input type="checkbox" class="form-check-input {{CSS.NEWWINDOW}}" id="{{elementid}}_{{CSS.NEWWINDOW}}"/><label class="form-check-label" for="{{elementid}}_{{CSS.NEWWINDOW}}">{{get_string "openinnewwindow" component}}</label></div></div><div data-type="{{CSS.ADVANCED}}" class="tab-pane" id="{{elementid}}_{{CSS.ADVANCED}}"><label for="{{elementid}}_{{CSS.IDINPUT}}">{{get_string "enterid" component}}</label><input class="form-control fullwidth {{CSS.IDINPUT}}" type="text" id="{{elementid}}_{{CSS.IDINPUT}}" /><label for="{{elementid}}_{{CSS.CLASSINPUT}}">{{get_string "enterclass" component}}</label><input class="form-control fullwidth {{CSS.CLASSINPUT}}" type="text" id="{{elementid}}_{{CSS.CLASSINPUT}}" /></div></div><div class="mdl-align"><br/><button class="btn btn-secondary submit" type="submit">{{get_string "createlink" component}}</button></div></form>');return this._content=h.Node.create(e({showFilepicker:t,component:n,CSS:i})),this._content.one(_.URLINPUT).on("keyup",this._updateTextToDisplay,this),this._content.one(_.URLINPUT).on("change",this._updateTextToDisplay,this),this._content.one(_.URLTEXT).on("keyup",this._setTextToDisplayState,this),this._content.one(_.SUBMIT).on("click",this._setLink,this),t&&this._content.one(_.LINKBROWSER).on("click",function(t){t.preventDefault(),this.get("host").showFilepicker("link",this._filepickerCallback,this)},this),this._content},_getContext:function(t){var e=this.get("host").canShowFilepicker("link");return h.merge({elementid:this.get("host").get("elementid"),component:n,showFilepicker:e,CSS:i},t)},_unlink:function(){var e=this.get("host"),t=e.getSelection();t&&t.length&&(t[0].startOffset===t[0].endOffset?(t=e.getSelectedNodes())&&(t.each(function(t){t=t.ancestor("a",!0);t&&(e.setSelection(e.getSelectionFromNode(t)),document.execCommand("unlink",!1,null))},this),this.markUpdated()):(document.execCommand("unlink",!1,null),this.markUpdated()))},_setTextToDisplayState:function(){var t=this._content.one(_.URLTEXT).get("value");this._hasTextToDisplay=""!==t},_updateTextToDisplay:function(){var t=this._content.one(_.URLINPUT),e=this._content.one(_.URLTEXT),t=t.get("value");this._hasTextToDisplay||e.set("value",t)},_getTextSelection:function(){var t,e,n="",i=window.getSelection(),o=i.rangeCount;if(o){for(t=[],e=0;e<o;++e)t.push(""+i.getRangeAt(e));n=t.join("")}return n}})},"@VERSION@",{requires:["moodle-editor_atto-plugin"]});